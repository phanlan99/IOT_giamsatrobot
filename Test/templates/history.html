<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data History & Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes bounceSubtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header with glass effect -->
        <header class="mb-8 glass-effect rounded-2xl p-6 animate-fade-in">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center animate-bounce-subtle">
                        <span class="text-2xl">üìä</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Analytics Dashboard</h1>
                        <p class="text-white/80">Supplement Detection & Insights</p>
                    </div>
                </div>
                <div class="text-white">
                    {% if username %}
                        <div class="flex items-center space-x-4">
                            <span class="bg-white/20 px-4 py-2 rounded-full">Welcome, {{ username }}!</span>
                            <a href="/logout" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full transition-colors">Logout</a>
                        </div>
                    {% else %}
                        <div class="space-x-4">
                            <a href="/login" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full transition-colors">Login</a>
                            <a href="/register" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-full transition-colors">Register</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="mb-6 animate-slide-up">
            <a href="/" class="inline-flex items-center space-x-2 bg-white/20 text-white px-4 py-2 rounded-full hover:bg-white/30 transition-colors">
                <span>‚Üê</span>
                <span>Back to Control Panel</span>
            </a>
        </div>

        <!-- Filter Section -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-8 card-hover animate-slide-up">
            <div class="flex items-center space-x-3 mb-6">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">üîç</span>
                </div>
                <h2 class="text-xl font-semibold text-gray-800">Filter & Search</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="space-y-2">
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input id="start-date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Select start date">
                </div>
                <div class="space-y-2">
                    <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input id="end-date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Select end date">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Actions</label>
                    <button id="filter-data" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105">
                        Apply Filter
                    </button>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">&nbsp;</label>
                    <button id="clear-filter" class="w-full bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">
                        Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="mb-8 animate-slide-up">
            <div class="flex items-center space-x-3 mb-6">
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">üìà</span>
                </div>
                <h2 class="text-xl font-semibold text-white">Summary Statistics</h2>
            </div>
            
            <div id="stats" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-xl card-hover">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-8 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-xl card-hover">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-8 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-xl card-hover">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-8 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">üìã</span>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">Detailed Records</h2>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-4 text-left text-sm font-semibold">ID</th>
                            <th class="px-4 py-4 text-left text-sm font-semibold">Record Time</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Beroca</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Cachua</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Cam</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Egg</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Maleutyl</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Probio</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Sui</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Topralsin</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">Vitatrum</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold">ZidocinDHG</th>
                            <th class="px-4 py-4 text-center text-sm font-semibold bg-blue-600">Total</th>
                        </tr>
                    </thead>
                    <tbody id="history-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="13" class="px-4 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center space-y-4">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                                    <span>Loading data...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        flatpickr("#start-date", { 
            dateFormat: "Y-m-d",
            theme: "material_blue"
        });
        flatpickr("#end-date", { 
            dateFormat: "Y-m-d",
            theme: "material_blue"
        });

        function createStatCard(title, value, icon = "üìä", color = "blue") {
            const colors = {
                blue: "from-blue-500 to-blue-600",
                green: "from-green-500 to-green-600",
                purple: "from-purple-500 to-purple-600",
                orange: "from-orange-500 to-orange-600",
                red: "from-red-500 to-red-600"
            };
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-xl card-hover border-l-4 border-${color}-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">${title}</p>
                            <p class="text-3xl font-bold text-gray-900">${value}</p>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-r ${colors[color]} rounded-full flex items-center justify-center">
                            <span class="text-white text-xl">${icon}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function fetchHistoryData(startDate, endDate) {
            const tbody = $('#history-table');
            const statsDiv = $('#stats');
            
            // Show loading state
            tbody.html('<tr><td colspan="13" class="px-4 py-12 text-center"><div class="flex flex-col items-center space-y-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><span class="text-gray-500">Loading data...</span></div></td></tr>');
            
            $.ajax({
                url: '/get_history',
                method: 'GET',
                data: { start_date: startDate, end_date: endDate },
                success: function(response) {
                    tbody.empty();
                    statsDiv.empty();

                    if (response.data.length === 0) {
                        tbody.append(`
                            <tr>
                                <td colspan="13" class="px-4 py-12 text-center">
                                    <div class="flex flex-col items-center space-y-4">
                                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                            <span class="text-3xl">üì≠</span>
                                        </div>
                                        <div>
                                            <p class="text-lg font-medium text-gray-900">No data found</p>
                                            <p class="text-gray-500">Try adjusting your filter criteria</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `);
                        statsDiv.append(createStatCard('No Data', '0', 'üì≠', 'gray'));
                    } else {
                        // Add data rows with alternating colors
                        response.data.forEach((row, index) => {
                            const total = (row.beroca || 0) + (row.cachua || 0) + (row.cam || 0) + 
                                        (row.egg || 0) + (row.maleutyl || 0) + (row.probio || 0) + 
                                        (row.sui || 0) + (row.topralsin || 0) + (row.vitatrum || 0) + 
                                        (row.zidocinDHG || 0);
                            
                            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                            tbody.append(`
                                <tr class="${rowClass} hover:bg-blue-50 transition-colors">
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${row.id}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${row.record_time}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.beroca > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.beroca || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.cachua > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.cachua || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.cam > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.cam || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.egg > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.egg || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.maleutyl > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.maleutyl || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.probio > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.probio || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.sui > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.sui || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.topralsin > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.topralsin || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.vitatrum > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.vitatrum || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center ${row.zidocinDHG > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'}">${row.zidocinDHG || 0}</td>
                                    <td class="px-4 py-3 text-sm text-center font-bold text-blue-600 bg-blue-50">${total}</td>
                                </tr>
                            `);
                        });

                        // Create beautiful stat cards
                        const statCards = [
                            createStatCard('Total Records', response.stats.total_records, 'üìä', 'blue'),
                            createStatCard('Total Items', response.stats.total_all, 'üì¶', 'green'),
                        ];

                        // Add individual supplement counts
                        const supplements = Object.entries(response.stats.total_counts);
                        const colors = ['purple', 'orange', 'red', 'blue', 'green'];
                        supplements.forEach(([key, value], index) => {
                            const color = colors[index % colors.length];
                            statCards.push(createStatCard(key, value, 'üíä', color));
                        });

                        statsDiv.html(statCards.join(''));
                    }
                },
                error: function() {
                    tbody.html(`
                        <tr>
                            <td colspan="13" class="px-4 py-12 text-center">
                                <div class="flex flex-col items-center space-y-4">
                                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
                                        <span class="text-3xl">‚ùå</span>
                                    </div>
                                    <div>
                                        <p class="text-lg font-medium text-red-900">Error loading data</p>
                                        <p class="text-red-600">Please try again later</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `);
                    statsDiv.html(createStatCard('Error', 'N/A', '‚ùå', 'red'));
                }
            });
        }

        $(document).ready(function() {
            fetchHistoryData();

            $('#filter-data').click(function() {
                const startDate = $('#start-date').val();
                const endDate = $('#end-date').val();
                fetchHistoryData(startDate, endDate);
            });

            $('#clear-filter').click(function() {
                $('#start-date').val('');
                $('#end-date').val('');
                fetchHistoryData();
            });
        });
    </script>
</body>
</html>