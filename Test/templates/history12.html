<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplement Detection History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-3xl mr-2">üìä</span>
                    <div>
                        <h1 class="text-2xl font-bold">Analytics Dashboard</h1>
                        <p class="text-gray-600">Supplement Detection & Insights</p>
                    </div>
                </div>
                <div>
                    {% if username %}
                        <p class="text-gray-700">Welcome, {{ username }}!</p>
                        <a href="{{ url_for('logout') }}" class="text-blue-500 hover:underline">Logout</a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="text-blue-500 hover:underline mr-4">Login</a>
                        <a href="{{ url_for('register') }}" class="text-blue-500 hover:underline">Register</a>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Back Button -->
        <a href="{{ url_for('index') }}" class="text-blue-500 hover:underline mb-4 inline-block">‚Üê Back to Control Panel</a>

        <!-- Filter Section -->
        <section class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-2">üîç</span>
                <h2 class="text-xl font-semibold">Filter & Search</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="start_date" class="block text-gray-700">Start Date</label>
                    <input type="date" id="start_date" class="w-full border rounded-lg p-2">
                </div>
                <div>
                    <label for="end_date" class="block text-gray-700">End Date</label>
                    <input type="date" id="end_date" class="w-full border rounded-lg p-2">
                </div>
                <div>
                    <label class="block text-gray-700">Actions</label>
                    <button onclick="fetchHistory()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Apply Filter</button>
                </div>
                <div>
                    <label class="block text-gray-700">&nbsp;</label>
                    <button onclick="clearFilters()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Clear All</button>
                </div>
            </div>
            <!-- Analysis Button -->
            <div class="mt-4">
                <label for="analysis_date" class="block text-gray-700">Analyze Specific Date</label>
                <div class="flex items-center">
                    <input type="date" id="analysis_date" name="analysis_date" class="w-full border rounded-lg p-2 mr-2">
                    <form action="{{ url_for('phantich') }}" method="POST">
                        <input type="hidden" name="analysis_date" id="hidden_analysis_date">
                        <button type="submit" onclick="setHiddenDate()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">View Analysis</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Summary Statistics -->
        <section class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-2">üìà</span>
                <h2 class="text-xl font-semibold">Summary Statistics</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-100 p-4 rounded-lg">
                    <p class="text-gray-700">Total Records</p>
                    <p id="total_records" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg">
                    <p class="text-gray-700">Total Supplements</p>
                    <p id="total_all" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <p class="text-gray-700">Breakdown</p>
                    <p id="breakdown" class="text-sm">Loading...</p>
                </div>
            </div>
        </section>

        <!-- Detailed Records -->
        <section class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-2">üìã</span>
                <h2 class="text-xl font-semibold">Detailed Records</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border p-2">ID</th>
                            <th class="border p-2">Record Time</th>
                            <th class="border p-2">Beroca</th>
                            <th class="border p-2">Cachua</th>
                            <th class="border p-2">Cam</th>
                            <th class="border p-2">Egg</th>
                            <th class="border p-2">Maleutyl</th>
                            <th class="border p-2">Probio</th>
                            <th class="border p-2">Sui</th>
                            <th class="border p-2">Topralsin</th>
                            <th class="border p-2">Vitatrum</th>
                            <th class="border p-2">ZidocinDHG</th>
                            <th class="border p-2">Total</th>
                        </tr>
                    </thead>
                    <tbody id="history_table">
                        <tr><td colspan="13" class="text-center p-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        function fetchHistory() {
            const startDate = $('#start_date').val();
            const endDate = $('#end_date').val();
            $.ajax({
                url: '/get_history',
                data: { start_date: startDate, end_date: endDate },
                success: function(response) {
                    updateTable(response.data);
                    updateStats(response.stats);
                },
                error: function() {
                    alert('Error fetching history data');
                }
            });
        }

        function updateTable(data) {
            const tbody = $('#history_table');
            tbody.empty();
            if (data.length === 0) {
                tbody.append('<tr><td colspan="13" class="text-center p-4">No data available</td></tr>');
                return;
            }
            data.forEach(row => {
                const total = (row.beroca || 0) + (row.cachua || 0) + (row.cam || 0) + (row.egg || 0) + 
                             (row.maleutyl || 0) + (row.probio || 0) + (row.sui || 0) + 
                             (row.topralsin || 0) + (row.vitatrum || 0) + (row.zidocinDHG || 0);
                tbody.append(`
                    <tr>
                        <td class="border p-2">${row.id || ''}</td>
                        <td class="border p-2">${row.record_time || ''}</td>
                        <td class="border p-2">${row.beroca || 0}</td>
                        <td class="border p-2">${row.cachua || 0}</td>
                        <td class="border p-2">${row.cam || 0}</td>
                        <td class="border p-2">${row.egg || 0}</td>
                        <td class="border p-2">${row.maleutyl || 0}</td>
                        <td class="border p-2">${row.probio || 0}</td>
                        <td class="border p-2">${row.sui || 0}</td>
                        <td class="border p-2">${row.topralsin || 0}</td>
                        <td class="border p-2">${row.vitatrum || 0}</td>
                        <td class="border p-2">${row.zidocinDHG || 0}</td>
                        <td class="border p-2">${total}</td>
                    </tr>
                `);
            });
        }

        function updateStats(stats) {
            $('#total_records').text(stats.total_records || 0);
            $('#total_all').text(stats.total_all || 0);
            const breakdown = stats.total_counts ? 
                Object.entries(stats.total_counts).map(([key, value]) => `${key}: ${value}`).join(', ') : 'No data';
            $('#breakdown').text(breakdown);
        }

        function clearFilters() {
            $('#start_date').val('');
            $('#end_date').val('');
            fetchHistory();
        }

        function setHiddenDate() {
            const analysisDate = $('#analysis_date').val();
            $('#hidden_analysis_date').val(analysisDate);
        }

        $(document).ready(function() {
            fetchHistory();
        });
    </script>
</body>
</html>